---

- name: "[Pretask] Update apt cache"
  hosts: all
  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 36000

- name: '[Pretask] Install pip'
  hosts: all
  tasks:
    - name: Install required packages
      become: true
      package:
        name: "{{ item }}"
        state: present
      with_items:
        - python3-pip
        - python3-mysqldb

- name: '[Pretask] Install docker'
  hosts: all
  roles:
    - role: docker

- name: '[Pretask] Create directories'
  hosts: all
  vars:
    docker_service_directory_db: /data/dummy/db
  tasks:
    - name: Create db data directory
      file:
        path: "{{ docker_service_directory_db }}"
        state: directory
        owner: "{{ ansible_user_id }}"
        group: "{{ ansible_user_id }}"
        mode: 0700

- name: Deploy the docker image managed by a systemd service
  hosts: all
  vars:
    docker_image: nginx:alpine
    docker_db_image: mariadb
    service_name: dummy
    docker_service_directory_db: /data/dummy/db
    enable_redis: true
    docker_service_directory_redis: /data/dummy/redis
    docker_command: |
      /usr/bin/docker run --rm --name {{ service_name }} \
      -p 8080:80 \
      -v {{ docker_service_volume_name }}:/usr/share/nginx/html \
      --network {{ service_name }} \
      {{ docker_image }}
    db_pass: 's3cr3t'
    db_user_pass: 's3cr3t'
    db_config_port: 3306
    db_name: dummy
    db_user: johndoe
  roles:
    - role: generic_docker_systemd
